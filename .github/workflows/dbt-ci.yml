name: dbt CI

on:
  pull_request:
    paths:
      - 'dbt/**'
  push:
    branches:
      - main
    paths:
      - 'dbt/**'

env:
  DBT_PROFILES_DIR: ${{ github.workspace }}/dbt
  DBT_CLIENT: acme

jobs:
  dbt-test:
    name: dbt Test & Compile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dbt
        run: |
          pip install dbt-core dbt-snowflake
      
      - name: Create dbt profiles
        working-directory: dbt
        run: |
          cp profiles.yml.example profiles.yml
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: TRANSFORMER
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      
      - name: dbt deps
        working-directory: dbt
        run: dbt deps
      
      - name: dbt compile
        working-directory: dbt
        run: dbt compile
      
      - name: dbt test (on PR only)
        if: github.event_name == 'pull_request'
        working-directory: dbt
        run: dbt test --select state:modified+
